<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Community Forum</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <nav class="navbar">
        <div class="nav-left">
            <h2>FarmerAI</h2>
        </div>
        <div class="nav-right"><button onclick="goBack()">â¬… Dashboard</button></div>
    </nav>

    <div style="max-width:900px;margin:24px auto;">
        <h2>Community Forum</h2>

        <div style="margin-bottom:18px;">
            <h3>Create a post</h3>
            <form id="postForm">
                <input name="title" placeholder="Title" required style="width:100%;padding:10px;margin-bottom:8px;" />
                <textarea name="content" placeholder="Describe your issue or share tips..." required
                    style="width:100%;padding:10px;height:120px;"></textarea>
                <input name="tags" placeholder="tags (comma separated, optional)"
                    style="width:100%;padding:10px;margin-top:8px;" />
                <button type="submit">Post</button>
            </form>
        </div>

        <h3>Recent posts</h3>
        <div id="postsList">Loading...</div>
    </div>

    <script>

        function goBack() { window.location.href = '/dashboard.html' }

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const f = e.target;
            const payload = {
                title: f.title.value,
                content: f.content.value,
                username: "DemoUser",   // ðŸ‘ˆ for now
                tags: f.tags.value ? f.tags.value.split(',').map(s => s.trim()) : []
            };
            const res = await fetch('/api/forum/post', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (res.ok) { f.reset(); loadPosts(); } else alert(data.error || 'Failed');
        });


        async function loadPosts() {
            const res = await fetch('/api/forum');
            const data = await res.json();
            if (!res.ok) return document.getElementById('postsList').innerText = data.error || 'Failed';
            if (data.posts.length === 0) return document.getElementById('postsList').innerHTML = '<p>No posts yet</p>';
            let html = '';
            data.posts.forEach(p => {
                html += `<div style="border:1px solid #ddd;padding:12px;margin-bottom:12px;border-radius:8px;">
      <h4>${p.title}</h4>
      <p style="color:#555">${p.content}</p>
      <div style="font-size:13px;color:#777">by ${p.username} â€¢ ${new Date(p.createdAt).toLocaleString()}</div>
      <div id="replies-${p._id}" style="margin-top:10px">${renderReplies(p.replies)}</div>
      <div style="margin-top:10px;">
        <input id="replyInput-${p._id}" placeholder="Write a reply..." style="width:70%;padding:8px"/>
        <button onclick="replyPost('${p._id}')">Reply</button>
      </div>
    </div>`;
            });
            document.getElementById('postsList').innerHTML = html;
        }
        function renderReplies(replies) {
            if (!replies || replies.length === 0) return '<div style="color:#777;margin-top:8px">No replies yet</div>';
            return '<div style="margin-top:8px;">' + replies.map(r => `<div style="padding:6px;border-top:1px dashed #eee"><b>${r.username}</b>: ${r.reply} <div style="font-size:12px;color:#999">${new Date(r.createdAt).toLocaleString()}</div></div>`).join('') + '</div>';
        }
        async function replyPost(id) {
            const input = document.getElementById('replyInput-' + id);
            const text = input.value.trim();
            if (!text) return alert('Type a reply');
            const res = await fetch('/api/forum/' + id + '/reply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reply: text, username: "DemoUser" }) // ðŸ‘ˆ add username
            });
            const data = await res.json();
            if (res.ok) { input.value = ''; loadPosts(); } else alert(data.error || 'Failed');
        }


        loadPosts();
    </script>
</body>

</html>